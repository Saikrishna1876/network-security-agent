import scapy.all as scapy
import os
import time
from collections import defaultdict, deque
from dotenv import load_dotenv
import ipaddress
import requests

load_dotenv()

# Configuration for C2 detection
# Time window to consider for periodic connections (e.g., 5 minutes)
C2_TIME_WINDOW = 300
# Minimum number of connections within the time window to be considered suspicious
MIN_CONNECTIONS = 50
# Tolerance for periodicity (e.g., connections within 10% of the average interval)
PERIODICITY_TOLERANCE = 0.1
# Threshold for small data transfers (bytes)
SMALL_DATA_THRESHOLD = 100

# Store connection timestamps for each flow (src_ip, dst_ip, dst_port)
# Using deque to efficiently store a limited number of recent timestamps
connection_timestamps = defaultdict(lambda: deque(maxlen=MIN_CONNECTIONS * 2))

# Store data transfer sizes for each flow
data_transfer_sizes = defaultdict(lambda: deque(maxlen=MIN_CONNECTIONS * 2))


def is_private_ip(ip_address):
    """
    Checks if an IP address is a private IP address.
    """
    try:
        ip_obj = ipaddress.ip_address(ip_address)
        return ip_obj.is_private
    except ValueError:
        return False


def analyze_flow(flow_key):
    """
    Analyzes a network flow for C2 characteristics (periodicity, small data transfers).
    """
    timestamps = connection_timestamps[flow_key]
    data_sizes = data_transfer_sizes[flow_key]

    if len(timestamps) < MIN_CONNECTIONS:
        return

    # Check for periodicity
    intervals = []
    for i in range(1, len(timestamps)):
        intervals.append(timestamps[i] - timestamps[i - 1])

    if len(intervals) > 1:
        avg_interval = sum(intervals) / len(intervals)
        is_periodic = True
        for interval in intervals:
            if not (
                avg_interval * (1 - PERIODICITY_TOLERANCE)
                <= interval
                <= avg_interval * (1 + PERIODICITY_TOLERANCE)
            ):
                is_periodic = False
                break

        if is_periodic and avg_interval > 0:
            print(
                f"[!!!] C2 Alert: Periodic connection detected for flow {flow_key}. Average interval: {avg_interval:.2f}s"
            )
            url = os.getenv("NOTIFY_WEBHOOK_URL")
            if url:
                requests.post(
                    url,
                    data=f"C2 Alert: Periodic connection detected for flow {flow_key}. Average interval: {avg_interval:.2f}s".encode(
                        encoding="utf-8"
                    ),
                )

    # Check for small, consistent data transfers
    if len(data_sizes) >= MIN_CONNECTIONS:
        small_data_count = sum(1 for size in data_sizes if size <= SMALL_DATA_THRESHOLD)
        if small_data_count >= MIN_CONNECTIONS:
            print(
                f"[!!!] C2 Alert: Consistent small data transfers detected for flow {flow_key}."
            )
            url = os.getenv("NOTIFY_WEBHOOK_URL")
            if url:
                requests.post(
                    url,
                    data=f"C2 Alert: Consistent small data transfers detected for flow {flow_key}.".encode(
                        encoding="utf-8"
                    ),
                )


def process_packet(packet):
    """
    Processes sniffed packets to detect potential malware C2 activity.
    """
    if packet.haslayer(scapy.IP):
        src_ip = packet[scapy.IP].src
        dst_ip = packet[scapy.IP].dst

        # Filter out internal network traffic for C2 detection (focus on external connections)
        if is_private_ip(dst_ip):
            return

        protocol = None
        dst_port = None
        payload_size = 0

        if packet.haslayer(scapy.TCP):
            protocol = "TCP"
            dst_port = packet[scapy.TCP].dport
            if packet.haslayer(scapy.Raw):
                payload_size = len(packet[scapy.Raw].load)
        elif packet.haslayer(scapy.UDP):
            protocol = "UDP"
            dst_port = packet[scapy.UDP].dport
            if packet.haslayer(scapy.Raw):
                payload_size = len(packet[scapy.Raw].load)

        if protocol and dst_port:
            flow_key = (src_ip, dst_ip, dst_port, protocol)
            current_time = time.time()

            connection_timestamps[flow_key].append(current_time)
            data_transfer_sizes[flow_key].append(payload_size)

            # Only analyze if enough data points are collected within the time window
            if (current_time - connection_timestamps[flow_key][0]) <= C2_TIME_WINDOW:
                analyze_flow(flow_key)


def sniff_traffic(interface):
    """
    Starts sniffing network traffic on the specified interface.
    """
    print(f"[*] Starting Malware C2 detector on interface {interface}...")
    # Filter for IP traffic (TCP and UDP)
    scapy.sniff(iface=interface, filter="ip", store=False, prn=process_packet)


if __name__ == "__main__":
    interface = os.getenv("INTERFACE")
    if not interface:
        print(
            "Error: INTERFACE environment variable not set. Please set the INTERFACE environment variable (e.g., eth0, wlan0)."
        )
        exit(1)

    sniff_traffic(interface)
